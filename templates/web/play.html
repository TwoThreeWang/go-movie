{{ template "base.html" . }}
{{ define "title" }}
<title>{{.name}} åœ¨çº¿è§‚çœ‹ - Moovie å…¨ç½‘å½±è§†èšåˆå¹³å°</title>
<meta name="description" content="æ­£åœ¨æ’­æ”¾ã€Š{{.name}}ã€‹ï¼ŒMoovie èšåˆå…¨ç½‘å½±è§†èµ„æºï¼Œä¸ºä½ æä¾›é«˜æ¸…æ’­æ”¾ã€å¤šæºåˆ‡æ¢ä¸æ™ºèƒ½ç»­æ’­åŠŸèƒ½ã€‚å‘ç°æ›´å¤šç²¾å½©ç”µå½±ï¼Œå°±åœ¨ Moovieã€‚">
<meta name="keywords" content="{{.name}}, {{.name}}åœ¨çº¿è§‚çœ‹, {{.name}}å®Œæ•´ç‰ˆ, {{.name}}é«˜æ¸…æ’­æ”¾, Moovie, å½±è§†æ’­æ”¾, å…¨ç½‘å½±è§†èšåˆ, åœ¨çº¿çœ‹ç”µå½±, å…è´¹è¿½å‰§">
<link rel="canonical" href="https://moovie.c2v2.com/play?source={{.source}}&vid={{.vid}}&name={{.name}}&play={{.play}}">
<meta property="og:title" content="{{.name}} åœ¨çº¿è§‚çœ‹ - Moovie">
<meta property="og:description" content="æ­£åœ¨æ’­æ”¾ã€Š{{.name}}ã€‹ï¼Œå…¨ç½‘èšåˆï¼Œä¸€é”®ç›´è¾¾å¯æ’­æ”¾æºã€‚">
<meta property="og:type" content="video.movie">
<meta property="og:url" content="https://moovie.app/play?source={{.source}}&vid={{.vid}}&name={{.name}}&play={{.play}}">
{{end}}
{{ define "schema" }}
{
  "@context": "https://schema.org",
  "@type": "Movie",
  "name": "{{.name}}",
  "description": "æ­£åœ¨æ’­æ”¾ã€Š{{.name}}ã€‹ï¼ŒMoovie èšåˆå…¨ç½‘å½±è§†èµ„æºï¼Œä¸ºä½ æä¾›é«˜æ¸…æ’­æ”¾ã€å¤šæºåˆ‡æ¢ä¸æ™ºèƒ½ç»­æ’­åŠŸèƒ½ã€‚å‘ç°æ›´å¤šç²¾å½©ç”µå½±ï¼Œå°±åœ¨ Moovieã€‚",
  "potentialAction": {
    "@type": "WatchAction",
    "target": "https://moovie.c2v2.com/play?source={{.source}}&vid={{.vid}}&name={{.name}}&play={{.play}}"
  }
}
{{end}}
{{ define "content" }}
<style>
#dplayer{
    position: relative;
    width: 100%;
    background: #000;
    margin-bottom: 1rem;
    border-radius: 8px;
    overflow: hidden;
    max-height: 90dvh; /* ä¸è¶…è¿‡å±å¹•é«˜åº¦ */
    aspect-ratio: 16 / 9; /* ä¿æŒ9:16æ¯”ä¾‹ */
}
.movie-detail {
  display: grid;
    grid-template-areas:
    "poster info"
    "poster more"
    "desc desc";
  grid-template-columns: 200px 1fr;
  gap: 16px;
  align-items: start;
  margin: 0 auto;
  padding: 16px;
  border: 1px dotted var(--border-color);
  border-radius: 8px;
}
.movie-detail .movie-title {
  font-size: 1.8rem;
  margin: 0;
margin-bottom: 0.5rem;
text-align: left;
color: var(--bg-primary-text);
}
.movie-detail .movie-poster {
  grid-area: poster;
  width: 100%;
  max-width: 200px;
}

.movie-detail .movie-poster img {
  width: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.movie-detail .movie-meta {
  grid-area: info;
  color: var(--secondary-text-one);
}
.movie-detail .movie-more{
   grid-area: more;
   font-size: 0.9em;
   color: var(--secondary-text-one);
}

.movie-info span {
  background-color: var(--border-color);
    padding: 2px 6px;
    border-radius: 4px;
}

.movie-detail .movie-desc {
  grid-area: desc;
  color: var(--secondary-text-two);
    line-height: 1.8;
}
.episodes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
}
.episode-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--primary-text);
    color: var(--bg-primary-text);
    cursor: pointer;
    transition: all 0.3s;
}
.episode-btn:hover,
.episode-btn.active {
    background: var(--primary-color);
    color: var(--primary-text);
    border-color: var(--primary-color);
}
.related-title {
    margin: 2rem 0 1rem;
    color: var(--primary-color);
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
@media(max-width: 768px) {
    .movie-detail {
        grid-template-areas:
        "poster info"
        "more more"
        "desc desc";
        grid-template-columns: 120px 1fr;
        gap: 12px;
  }
}
</style>
<div class="breadcrumb">
    <a href="/">é¦–é¡µ</a>
    <span>/</span>
    <span>{{.name}} åœ¨çº¿è§‚çœ‹</span>
</div>
<div class="video-container">
    <div id="dplayer"></div>
</div>
<div class="movie-detail" id="movie-detail">
    <div id="load">
        <span class="cow-emoji" role="img" aria-label="Cow">ğŸ¬</span>
        <p>è§†é¢‘è¯¦ç»†ä¿¡æ¯åŠ è½½ä¸­...</p>
    </div>
</div>
<div class="title">
    <svg viewBox="0 0 24 24">
        <polygon points="5 4 15 12 5 20" />
    </svg>
    é€‰é›†æ’­æ”¾
</div>
<div class="episodes" id="episodes"></div>
<br>
<div class="title">
    <svg viewBox="0 0 24 24">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
    </svg>
    æ›´å¤šè§†é¢‘æº
</div>
<div class="movies" id="more-movies"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.6.13/hls.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" charset="utf-8" src="https://cdnjs.cloudflare.com/ajax/libs/dplayer/1.27.1/DPlayer.min.js"></script>
<script type="text/javascript">
videoID = '{{.source}}{{.vid}}';
function dplayer(url,pic,title){
    const dp = new DPlayer({
        container: document.getElementById('dplayer'),
        autoplay:true,
        airplay:true,
        preload: 'auto',//è§†é¢‘é¢„åŠ è½½
        chromecast:true,
        video: {
            url: url,
            type: 'hls',
            pic: pic,   //è§†é¢‘å°é¢
        },
        pluginOptions: {
            hls: {
                maxBufferLength: 120,       // ç¼“å†² 120 ç§’
                maxMaxBufferLength: 180,    // ç¡¬ä¸Šé™ 180 ç§’
                startFragPrefetch: true,    // æå‰åŠ è½½ä¸‹ä¸€ä¸ªåˆ†ç‰‡
                maxBufferSize: 200 * 1000 * 1000, // ç¼“å†²åŒºæœ€å¤§ 200MB
                autoStartLoad: true,        // è‡ªåŠ¨åŠ è½½
            },
        },
    });

    const movie = Storage.getById(videoID);
    var lastTime = 0;
    if(movie&&movie.title==title){
        lastTime = movie.lastTime;
    }

    dp.on('pause', () => {
        showad();
        const hls = dp.plugins.hls;
        if (hls) {
            hls.startLoad(); // è®©å®ƒç»§ç»­åŠ è½½åˆ†ç‰‡
        }
    });
    dp.on('play', () => {
        closead();
    });
    dp.on('loadedmetadata', () => {
        if (lastTime > 0 && lastTime < dp.video.duration) {
            dp.seek(lastTime); // æ¢å¤ä¸Šæ¬¡æ’­æ”¾æ—¶é—´
        }
        const video = dp.video;
        if (video) {
            video.preservesPitch = true;
            video.mozPreservesPitch = true;
            video.webkitPreservesPitch = true;
        }
    });
    dp.on('timeupdate', function () {
        Storage.upsert({
            id: videoID,
            title: title,
            source: "{{.source}}",
            vid: "{{.vid}}",
            play: btoa(url),
            lastTime:dp.video.currentTime,
            img: pic
        });
    });

    // å¹¿å‘Šé…ç½®
    var adpic = "../public/static/img/ad.png";
    var adlink = "/page/about";
    var adtim = "5";
    var autoclose = "1";

    // è·å– player å…ƒç´ 
    var player = document.getElementById('dplayer');

    // 1ï¸æ’å…¥å¹¿å‘Š HTML
    var adboxHTML = `
    <div id="overlay">
        <div class="adbox">
            <a href="${adlink}" target="_blank" rel="nofollow">
                <img src="${adpic}">
            </a>
            <span id="closead" onclick="closead()">ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­å¹¿å‘Š</span>
        </div>
    </div>
    <style type="text/css">
    #overlay{position:absolute;z-index:7;background:rgba(0,0,0,0.6);top:0;bottom:0;left:0;right:0}
    .adbox{position:absolute;z-index:8;background-color:#000;margin:auto;top:0;bottom:0;left:0;right:0;width:50%;max-height:80%;border: 4px solid #f60c3e;border-radius:8px}
    .adbox img{width:100%;height:100%;position:absolute;margin:auto;top:0;left:0;border-radius:7px;object-fit:contain;border-radius:8px}
    #closead{position:relative;z-index:8;color:#FFF;background:#f60c3e;float:right;font-size:14px;padding:10px;cursor:pointer;}
    </style>
    `;

    // åŸç”Ÿ JS ç­‰ä»· prepend
    player.insertAdjacentHTML('afterbegin', adboxHTML);
    var adbox = document.getElementById('overlay');
    function closead(){
        if (adbox) {
        adbox.style.display = 'none';
        }
        dp.play();
    }
    function showad(){
        if (adbox) {
        adbox.style.display = 'block';
        }
    }
    // ç‚¹å‡» overlay å…³é—­å¹¿å‘Š
    adbox.addEventListener('click', closead);

    // é˜»æ­¢ adbox å†…éƒ¨ç‚¹å‡»å†’æ³¡
    document.querySelector('.adbox').addEventListener('click', function(event) {
        event.stopPropagation();
    });
}
function get_link_dict(str){
    // æ‹†åˆ†è§†é¢‘é“¾æ¥
    var index = 0
    var play_link = new Map([])
    var play = atob({{.play}})
    var play_name = ""
    for (var item_one of str.split('$$$')) {
        if (item_one.indexOf(".m3u8") != -1){
            // å…ˆæ‹†åˆ†æ¯ä¸€é›†
            for(var item of item_one.split('#')) {
                index += 1
                var list_two = item.split('$') // å†æ‹†åˆ†æ ‡é¢˜å’Œé“¾æ¥
                play_link.set(list_two[0],btoa(list_two[1]))
                if(play==""&&index==1){
                    play = list_two[1]
                    play_name = list_two[0]
                }else if(play==list_two[1]&&play_name==""){
                    play_name = list_two[0]
                }
            }
        }
    }
    return {
        play_link: play_link,
        play: play,
        play_name: play_name
    }
}
async function getDetail() {
    try {
        const response = await sendRequest('GET', '/api/detail?source={{.source}}&id={{.vid}}');

        if (response.code !== 200) {
            throw new Error(`HTTP error! status: ${response.msg}`);
        }
        const movie_data = await response.data;
        if (movie_data==null){
            showMsg('åŠ è½½å½±è§†æ•°æ®å¤±è´¥ï¼Œé‡æ–°æœç´¢è¯•è¯•ï¼Ÿ', "error")
            return
        }
        var { play_link, play, play_name } = get_link_dict(movie_data.VodPlayUrl);
        dplayer(play,movie_data.VodPic,movie_data.VodName+play_name)
        var movie_info = document.getElementById("movie-detail");
        movie_info.innerHTML = `<div class="movie-poster">
            <img src="${movie_data.VodPic}" loading="lazy" alt="${movie_data.VodName}" referrerPolicy="no-referrer">
            </div>
            <div class="movie-meta">
                <p class="movie-title">${movie_data.VodName} <small>${play_name}</small></p>
                <div class="movie-info">
                    <span>${movie_data.Source}</span>
                    <span>${movie_data.TypeName}</span>
                    <span>${movie_data.VodTag}</span>
                    <span>${movie_data.VodArea}</span>
                    <span>${movie_data.VodLang}</span>
                    <span>${movie_data.VodYear}</span>
                </div>
            </div>
            <div class="movie-more">
                <p><b>åˆå</b>ï¼š${movie_data.VodSub}</p>
                <p><b>å¯¼æ¼”</b>ï¼š${movie_data.VodDirector}</p>
                <p><b>ä¸»æ¼”</b>ï¼š${movie_data.VodActor}</p>
                <p><b>ä¸Šæ˜ </b>ï¼š${movie_data.VodPubdate}</p>
                <p><b>é›†æ•°</b>ï¼š${movie_data.VodRemarks}</p>
                <p><b>è±†ç“£</b>ï¼š<a href="https://movie.douban.com/subject/${movie_data.VodDoubanId}" target="_blank">${movie_data.VodName}ï¼ˆ${movie_data.VodDoubanScore}ï¼‰</a></p>
                <p><b>æ›´æ–°</b>ï¼š${movie_data.VodTime}</p>
            </div>
            <div class="movie-desc">${movie_data.VodContent}</div>`
        var episodes = document.getElementById("episodes");
        for (const [key, value] of play_link) {
            if (value==btoa(play)){
                episodes.innerHTML += `<a href="/play?source={{.source}}&vid={{.vid}}&play=${value}&name=${movie_data.VodName}" class="episode-btn active">${key}</a>`
            }else{
                episodes.innerHTML += `<a href="/play?source={{.source}}&vid={{.vid}}&play=${value}&name=${movie_data.VodName}" class="episode-btn">${key}</a>`
            }
        }
        getMoreMovie(movie_data.VodName);
    } catch (error) {
        console.error('åŠ è½½å½±è§†æ•°æ®å¤±è´¥:', error);
        showMsg('åŠ è½½å½±è§†æ•°æ®å¤±è´¥ï¼Œé‡æ–°æœç´¢è¯•è¯•ï¼Ÿ', "error")
    }
}
async function getMoreMovie(name) {
    try {
        const response = await sendRequest('GET', '/api/search?kw='+name);

        if (response.code !== 200) {
            throw new Error(`HTTP error! status: ${response.msg}`);
        }
        const movies_data = await response.data;
        var more_movies = document.getElementById("more-movies");
        for (let i = 0; i < movies_data.length; i++) {
            var item = movies_data[i];
            if(item.source == {{.source}} && item.vod_id=={{.vid}}){
                continue
            }
            more_movies.innerHTML += `<a href="/play?source=${item.source}&vid=${item.vod_id}&name=${item.vod_name}" class="movie-card">
                <div class="movie-poster">
                    <img loading="lazy" referrerPolicy="no-referrer" src="${item.vod_pic}" alt="${item.vod_name}">
                </div>
                <div class="movie-title">${item.vod_name}</div>
                <div class="movie-info">
                    <span>${item.vod_year}</span>
                    <span>${item.vod_area}ï½œ${item.type_name}</span>
                    <span>${item.vod_director}(å¯¼)</span>
                    <span>${item.source}(${item.vod_remarks})</span>
                </div>
            </a>`
        }
    } catch (error) {
        console.error('åŠ è½½å½±è§†æ•°æ®å¤±è´¥:', error);
        showMsg('åŠ è½½å½±è§†æ•°æ®å¤±è´¥ï¼Œé‡æ–°æœç´¢è¯•è¯•ï¼Ÿ', "error")
    }
}
// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function () {
    getDetail();
});
</script>
{{ end }}