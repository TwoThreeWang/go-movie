{{ template "base.html" . }}

{{ define "content" }}
<div class="hero">
    <div class="logo">ğŸ® Moovie</div>
    <p class="slogan">æœå…¨ç½‘ï¼Œåªä¸ºä½ æƒ³çœ‹çš„é‚£ä¸€éƒ¨</p>
    <p class="slogan">ä½ çš„æ–°è‘¡äº¬æ¾³é—¨å¨å°¼æ–¯æœ‹å‹æ¥äº†</p>
    <form action="/search" class="search-box">
        <input type="text" placeholder="æƒ³çœ‹å°±æœï¼Œçœ‹ä½ æƒ³çœ‹..." aria-label="æœç´¢ç”µå½±" name="kw">
        <button>æœç´¢</button>
    </form>
    <div class="keywords-box dot-bg" id="hotkw">
        <a href="">çƒ­æœæ•°æ®åŠ è½½ä¸­...</a>
    </div>
</div>
<div class="title">
    <svg viewBox="0 0 24 24">
        <polygon points="5 4 15 12 5 20" />
    </svg>
    ç»§ç»­è§‚çœ‹
</div>
<div id="load"><span class="cow-emoji" role="img" aria-label="Cow">ğŸ¿</span><p>æ’­æ”¾è®°å½•ç©ºç©ºçš„ï¼Œå»å‘ç°ä¸€éƒ¨è®©ä½ ä¸Šå¤´çš„ç”µå½±å§ï½</p></div>
<div class="movies" id="history"></div>
<script>
    // è·å–çƒ­é—¨æœç´¢
    async function loadHotKey() {
        const hotkw = document.getElementById("hotkw");
        try {
            const response = await sendRequest('GET', '/api/searchhistory');

            if (response.code !== 200) {
                throw new Error(`HTTP error! status: ${response.msg}`);
            }

            const kws = await response.data;
            var hotkw_html = '';
            for (let i = 0; i < kws.length; i++) {
                hotkw_html += `<a href="/search?kw=${kws[i]}">${kws[i]}</a>`
            }
            hotkw.innerHTML = hotkw_html;
        } catch (error) {
            console.error('åŠ è½½ç½‘ç«™æ•°æ®å¤±è´¥:', error);
            showMsg('åŠ è½½ç½‘ç«™æ•°æ®å¤±è´¥:' + error, "error")
            hotkw.innerHTML = `çƒ­é—¨æœç´¢å…³é”®è¯åŠ è½½å¤±è´¥ï¼`;
        }
    }

    function getHistory(){
        const history_div = document.getElementById("history");
        const all_history = Storage.getAll();
        console.log(all_history);
        history_html = "";
        for (let i = 0; i < all_history.length; i++) {
            var item = all_history[i];
            const percentage = Math.round((item['lastTime'] / item['duration']) * 100);
            var stroke_dashoffset = 251 - percentage * 2.51;

            history_html += `<a href="/play?source=${item['source']}&vid=${item['vid']}&play=${item['play']}&name=${item['title']}" class="movie-card">
        <div class="movie-poster">
            <img loading="lazy" src="${item['img']}" alt="${item['title']}" referrerPolicy="no-referrer">
        </div>
        <div class="movie-title">${item['title']}</div>
        <div class="movie-rating">
            <span title="èµ„æºæ¥æº">Â© ${item['source']}</span>
            <svg id="p" viewBox="0 0 100 100">
                <title>æ’­æ”¾è¿›åº¦</title>
                <circle cx="50" cy="50" r="40" fill="none" stroke="#eee" stroke-width="5"></circle>
                <circle id="c" cx="50" cy="50" r="40" fill="none" stroke="#f60c3e" stroke-width="5" stroke-dasharray="251" stroke-dashoffset="${stroke_dashoffset}" transform="rotate(-90 50 50)"  stroke-linecap="round"></circle>
                <text id="t" x="50" y="60" text-anchor="middle" font-size="30" fill="#333">${percentage}%</text>
            </svg>
            <div class="delete-btn" onclick="delHistory('${item['id']}')">
                <title>æ ‡è®°å®Œæˆï¼Œåˆ é™¤è®°å½•</title>
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M9 12l2 2 4-4" />
                </svg>
            </div>
        </div>
    </a>`
        }
        if(history_html!=""){
            document.getElementById("load").style.display = "none"
        }
        history_div.innerHTML = history_html;
    }
    function delHistory(id){
        event.stopPropagation();
        event.preventDefault();
        Storage.remove(id);
        getHistory();
        showMsg("å·²åˆ é™¤","success");
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
        loadHotKey();
        getHistory();
    });
</script>
{{ end }}
