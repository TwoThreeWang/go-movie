{{ template "base.html" . }}
{{ define "title" }}
<title>{{.kw}} 全网影视搜索结果 - Moovie</title>
<meta name="description" content="Moovie 为你聚合全网影视资源，找到与“{{.kw}}”相关的电影、电视剧、综艺节目等内容，无需注册，即点即看。">
<meta name="keywords" content="{{.kw}}, {{.kw}}在线观看, {{.kw}}电影, {{.kw}}电视剧, 影视搜索, Moovie, 全网影视聚合, 在线看片">
<link rel="canonical" href="https://moovie.c2v2.com/search?kw={{.kw}}">
{{end}}
{{ define "schema" }}
{{end}}
{{ define "content" }}
<style>
    .search-header {
        border-bottom: 1px dotted #eee;
        margin-bottom: 2rem;
    }
</style>
<div class="breadcrumb">
    <a href="/">首页</a>
    <span>/</span>
    <span>{{.kw}} 全网搜索</span>
</div>
<div class="search-header">
    <form action="/search" class="search-box">
        <input type="text" placeholder="想看就搜，看你想看..." aria-label="搜索电影" value="{{.kw}}"  name="kw">
        <button>搜索</button>
    </form>
</div>
<div id="load">
    <span class="cow-emoji" role="img" aria-label="Cow">🐮</span>
    <p>正在聚合搜索多个影视资源站...</p>
</div>
<div class="movies" id="movies"></div>
<br>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4678475430515042"
     crossorigin="anonymous"></script>
<!-- 自适应 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4678475430515042"
     data-ad-slot="5275519214"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.6.13/hls.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
function getM3u8(str){
    var list_one = item_one.split('#')
    var list_two = list_one[1].split('$')
    return list_two[1]
}
async function getSearch() {
    const movies = document.getElementById("movies");
    const load = document.getElementById("load");
    try {
        const response = await sendRequest('GET', '/api/search?kw={{.kw}}');

        if (response.code !== 200) {
            throw new Error(`HTTP error! status: ${response.msg}`);
        }
        const movies_data = await response.data;
        var movies_html = '';
        if(movies_data){
            for (let i = 0; i < movies_data.length; i++) {
                var item = movies_data[i];
                movies_html += `<a href="/play?source=${item.source}&vid=${item.vod_id}&name=${item.vod_name}" class="movie-card" title="现在播放《${item.vod_name}》">
                    <div class="movie-poster">
                        <img loading="lazy" src="${item.vod_pic}" alt="${item.vod_name} Movie Poster" referrerPolicy="no-referrer">
                    </div>
                    <div class="movie-title">${item.vod_name}</div>
                    <div class="movie-info">
                        <span>${item.vod_year}</span>
                        <span>${item.vod_area}｜${item.type_name}</span>
                        <span>${item.vod_director}(导)</span>
                        <span>${item.source}（${item.vod_remarks}）</span>
                        <span id="${item.source}${item.vod_id}" title="测速结果仅供参考，测速失败不一定无法播放">⏱️ 测速中...</span>
                    </div>
                </a>`
            }
        }
        if (movies_html == ""){
            load.innerHTML = `<span class="cow-emoji" role="img" aria-label="Cow">🤔</span><p>暂时没有搜索到影片资源，过段时间再试试呗！</p>`
        }else{
            load.style.display = "none";
        }
        movies.innerHTML = movies_html;
        Promise.all(
            movies_data.map(t => {
                const url = extractM3u8(t.vod_play_url);
                const divId = `${t.source}${t.vod_id}`;
                return testM3u8Speed(url, divId);
            })
        );
    } catch (error) {
        console.error('加载影视数据失败:', error);
        showMsg('加载影视数据失败，重新搜索试试？', "error")
        load.innerHTML = `<span class="cow-emoji" role="img" aria-label="Cow">🤔</span><p>暂时没有搜索到影片资源，过段时间再试试呗！</p>`
    }
}
function extractM3u8(vod_play_url) {
  if (!vod_play_url) return null;
  // 1. 先用 $ 分隔，取最后一个片段（大多数源都是这种格式）
  const parts = vod_play_url.split('$').filter(Boolean);
  let candidate = parts[parts.length - 1];
  // 2. 再从中用正则提取出 m3u8 链接
  const match = candidate.match(/https?:\/\/[^\s'"]+\.m3u8/);
  return match ? match[0] : null;
}
function testM3u8Speed(url, divId) {
  return new Promise((resolve) => {
    const video = document.createElement('video');
    video.style.display = 'none';
    video.muted = true;

    const startTime = performance.now();
    let loaded = false;

    // 设置 5 秒超时
    const timeout = setTimeout(() => {
      if (!loaded) {
        loaded = true;
        document.getElementById(divId).innerText = `⏱️ 测速失败`;
        if (hls) {
          hls.destroy();
        }
        video.remove();
        resolve(Infinity);
      }
    }, 5000);
    try {
        if (Hls.isSupported()) {
        const hls = new Hls();

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            const time = performance.now() - startTime;
            document.getElementById(divId).innerText = `⏱️ ${time.toFixed(2)} ms`;
            hls.destroy();
            video.remove();
            resolve(time);
            }
        });

        hls.on(Hls.Events.ERROR, () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            document.getElementById(divId).innerText = `⏱️ 测速失败`;
            hls.destroy();
            video.remove();
            resolve(Infinity);
            }
        });

        hls.loadSource(url);
        hls.attachMedia(video);
        } else {
        video.src = url;
        video.addEventListener('loadeddata', () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            const time = performance.now() - startTime;
            document.getElementById(divId).innerText = `⏱️ ${time.toFixed(2)} ms`;
            resolve(time);
            }
        });

        video.addEventListener('error', () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            document.getElementById(divId).innerText = `⏱️ 测速失败`;
            resolve(Infinity);
            }
        });
        }
    } catch (e) {
        document.getElementById(divId).innerText = `⏱️ 测速失败`;
        clearTimeout(timeout);
    }
    document.body.appendChild(video);
  });
}
// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function () {
    getSearch();
});
</script>
{{ end }}
