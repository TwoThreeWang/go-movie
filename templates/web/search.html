{{ template "base.html" . }}
{{ define "title" }}
<title>{{.kw}} å…¨ç½‘å½±è§†æœç´¢ç»“æœ - Moovie</title>
<meta name="description" content="Moovie ä¸ºä½ èšåˆå…¨ç½‘å½±è§†èµ„æºï¼Œæ‰¾åˆ°ä¸â€œ{{.kw}}â€ç›¸å…³çš„ç”µå½±ã€ç”µè§†å‰§ã€ç»¼è‰ºèŠ‚ç›®ç­‰å†…å®¹ï¼Œæ— éœ€æ³¨å†Œï¼Œå³ç‚¹å³çœ‹ã€‚">
<meta name="keywords" content="{{.kw}}, {{.kw}}åœ¨çº¿è§‚çœ‹, {{.kw}}ç”µå½±, {{.kw}}ç”µè§†å‰§, å½±è§†æœç´¢, Moovie, å…¨ç½‘å½±è§†èšåˆ, åœ¨çº¿çœ‹ç‰‡">
<link rel="canonical" href="https://moovie.c2v2.com/search?kw={{.kw}}">
{{end}}
{{ define "schema" }}
{{end}}
{{ define "content" }}
<style>
    .search-header {
        border-bottom: 1px dotted #eee;
        margin-bottom: 2rem;
    }
</style>
<div class="breadcrumb">
    <a href="/">é¦–é¡µ</a>
    <span>/</span>
    <span>{{.kw}} å…¨ç½‘æœç´¢</span>
</div>
<div class="search-header">
    <form action="/search" class="search-box">
        <input type="text" placeholder="æƒ³çœ‹å°±æœï¼Œçœ‹ä½ æƒ³çœ‹..." aria-label="æœç´¢ç”µå½±" value="{{.kw}}"  name="kw">
        <button>æœç´¢</button>
    </form>
</div>
<div id="load">
    <span class="cow-emoji" role="img" aria-label="Cow">ğŸ®</span>
    <p>æ­£åœ¨èšåˆæœç´¢å¤šä¸ªå½±è§†èµ„æºç«™...</p>
</div>
<div class="movies" id="movies"></div>
<br>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4678475430515042"
     crossorigin="anonymous"></script>
<!-- è‡ªé€‚åº” -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4678475430515042"
     data-ad-slot="5275519214"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.6.13/hls.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
function getM3u8(str){
    var list_one = item_one.split('#')
    var list_two = list_one[1].split('$')
    return list_two[1]
}
async function getSearch() {
    const movies = document.getElementById("movies");
    const load = document.getElementById("load");
    try {
        const response = await sendRequest('GET', '/api/search?kw={{.kw}}');

        if (response.code !== 200) {
            throw new Error(`HTTP error! status: ${response.msg}`);
        }
        const movies_data = await response.data;
        var movies_html = '';
        if(movies_data){
            for (let i = 0; i < movies_data.length; i++) {
                var item = movies_data[i];
                movies_html += `<a href="/play?source=${item.source}&vid=${item.vod_id}&name=${item.vod_name}" class="movie-card" title="ç°åœ¨æ’­æ”¾ã€Š${item.vod_name}ã€‹">
                    <div class="movie-poster">
                        <img loading="lazy" src="${item.vod_pic}" alt="${item.vod_name} Movie Poster" referrerPolicy="no-referrer">
                    </div>
                    <div class="movie-title">${item.vod_name}</div>
                    <div class="movie-info">
                        <span>${item.vod_year}</span>
                        <span>${item.vod_area}ï½œ${item.type_name}</span>
                        <span>${item.vod_director}(å¯¼)</span>
                        <span>${item.source}ï¼ˆ${item.vod_remarks}ï¼‰</span>
                        <span id="${item.source}${item.vod_id}" title="æµ‹é€Ÿç»“æœä»…ä¾›å‚è€ƒï¼Œæµ‹é€Ÿå¤±è´¥ä¸ä¸€å®šæ— æ³•æ’­æ”¾">â±ï¸ æµ‹é€Ÿä¸­...</span>
                    </div>
                </a>`
            }
        }
        if (movies_html == ""){
            load.innerHTML = `<span class="cow-emoji" role="img" aria-label="Cow">ğŸ¤”</span><p>æš‚æ—¶æ²¡æœ‰æœç´¢åˆ°å½±ç‰‡èµ„æºï¼Œè¿‡æ®µæ—¶é—´å†è¯•è¯•å‘—ï¼</p>`
        }else{
            load.style.display = "none";
        }
        movies.innerHTML = movies_html;
        Promise.all(
            movies_data.map(t => {
                const url = extractM3u8(t.vod_play_url);
                const divId = `${t.source}${t.vod_id}`;
                return testM3u8Speed(url, divId);
            })
        );
    } catch (error) {
        console.error('åŠ è½½å½±è§†æ•°æ®å¤±è´¥:', error);
        showMsg('åŠ è½½å½±è§†æ•°æ®å¤±è´¥ï¼Œé‡æ–°æœç´¢è¯•è¯•ï¼Ÿ', "error")
        load.innerHTML = `<span class="cow-emoji" role="img" aria-label="Cow">ğŸ¤”</span><p>æš‚æ—¶æ²¡æœ‰æœç´¢åˆ°å½±ç‰‡èµ„æºï¼Œè¿‡æ®µæ—¶é—´å†è¯•è¯•å‘—ï¼</p>`
    }
}
function extractM3u8(vod_play_url) {
  if (!vod_play_url) return null;
  // 1. å…ˆç”¨ $ åˆ†éš”ï¼Œå–æœ€åä¸€ä¸ªç‰‡æ®µï¼ˆå¤§å¤šæ•°æºéƒ½æ˜¯è¿™ç§æ ¼å¼ï¼‰
  const parts = vod_play_url.split('$').filter(Boolean);
  let candidate = parts[parts.length - 1];
  // 2. å†ä»ä¸­ç”¨æ­£åˆ™æå–å‡º m3u8 é“¾æ¥
  const match = candidate.match(/https?:\/\/[^\s'"]+\.m3u8/);
  return match ? match[0] : null;
}
function testM3u8Speed(url, divId) {
  return new Promise((resolve) => {
    const video = document.createElement('video');
    video.style.display = 'none';
    video.muted = true;

    const startTime = performance.now();
    let loaded = false;

    // è®¾ç½® 5 ç§’è¶…æ—¶
    const timeout = setTimeout(() => {
      if (!loaded) {
        loaded = true;
        document.getElementById(divId).innerText = `â±ï¸ æµ‹é€Ÿå¤±è´¥`;
        if (hls) {
          hls.destroy();
        }
        video.remove();
        resolve(Infinity);
      }
    }, 5000);
    try {
        if (Hls.isSupported()) {
        const hls = new Hls();

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            const time = performance.now() - startTime;
            document.getElementById(divId).innerText = `â±ï¸ ${time.toFixed(2)} ms`;
            hls.destroy();
            video.remove();
            resolve(time);
            }
        });

        hls.on(Hls.Events.ERROR, () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            document.getElementById(divId).innerText = `â±ï¸ æµ‹é€Ÿå¤±è´¥`;
            hls.destroy();
            video.remove();
            resolve(Infinity);
            }
        });

        hls.loadSource(url);
        hls.attachMedia(video);
        } else {
        video.src = url;
        video.addEventListener('loadeddata', () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            const time = performance.now() - startTime;
            document.getElementById(divId).innerText = `â±ï¸ ${time.toFixed(2)} ms`;
            resolve(time);
            }
        });

        video.addEventListener('error', () => {
            if (!loaded) {
            loaded = true;
            clearTimeout(timeout);
            document.getElementById(divId).innerText = `â±ï¸ æµ‹é€Ÿå¤±è´¥`;
            resolve(Infinity);
            }
        });
        }
    } catch (e) {
        document.getElementById(divId).innerText = `â±ï¸ æµ‹é€Ÿå¤±è´¥`;
        clearTimeout(timeout);
    }
    document.body.appendChild(video);
  });
}
// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function () {
    getSearch();
});
</script>
{{ end }}
